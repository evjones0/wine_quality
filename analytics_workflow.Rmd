---
title: "Vinho Verde Wine Analysis"
author: "Evan Jones"
date: "9/23/2020"
output: 
  html_document:
    toc: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(require(pacman)==F) install.packages("pacman")

pacman::p_load(tidyverse, DataExplorer, caret)

cat("\014")
rm(list = ls())
options(scipen = 10)

source("external_functions/data_summary.R")
```

# Overview

# Data Description
This dataset contains physicochemical and qualitative measures of red and white vinho verde wine from Portugal. The overall goal of this dataset is to predict wine quality in a 0 to 10 rating scale. Each quality observation is based on an expert review.

There are 13 total variables in the dataset.

Variable Name | Variable Type | Unit | Description
- | - | - | -
Fixed Acidity | Continuous | $g(tartaric\;acid)/dm^3$ | The concentration of tartaric acid in the wine bottle
Volatile Acidity | Continuous | $g(acetic\;acid)/dm^3$ | The concentration of acetic acid in the wine bottle
Citric Acid | Continuous | $g/dm^3$ | The concentration of citric acid in the wine bottle
Residual Sugar | Continuous | $g/dm^3$ | The concentration of sugar in the wine bottle
Chlorides | Continuous | $g/dm^3$ | The concentration of chlorides in the wine bottle
Free Sulfur Dioxide | Discrete | $mg/dm^3$ | The concentration of free sulfur dioxide in the wine bottle
Total Sulfur Dioxide | Discrete | $mg/dm^3$ | The overall concentration of sulfur dioxide in the wine bottle
Density | Continuous | $g/cm^3$ | The liquid density in the wine bottle
pH | Continuous | N/A | A measure of acidity and basicity in an aqueous solution. Values can range between 0 and 14. Values less than 7 indicate an acidic solution, whereas values above 7 indicate a basic solution. Exactly 7 indicates a neutral solution
Sulphates | Continuous | $g(potassium\;sulphate)/dm^3$ | The concentration of sulphates in the wine bottle
Alcohol | Continuous | % volume | % alcohol content of the wine bottle.
Quality | Discrete | N/A | 0-10 score assigned to the bottle
Color | Factor (2 levels) | N/A | Whether the wine is white or red

# Preprocessing
```{r, data_read, include = F}
# Read in datasets from UCI website

df_white <- read.csv2("https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-white.csv")
df_red <- read.csv2("https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv")

# Local backup fo dataset as of 8/23/20

# df_white <- read.csv2("./datasets/winequality-white.csv")
# df_red <- read.csv2("./datasets/winequality-red.csv")

# Union datasets
df_white$color <- "White"
df_red$color <- "Red"

df <- union_all(df_white, df_red)

rm(df_red, df_white)
```

```{r, variable_rename, include=F}
# Rename columns to snake case
df <- df %>% 
  rename(fixed_acidity = fixed.acidity,
         volatile_acidity = volatile.acidity,
         citric_acid = citric.acid,
         residual_sugar = residual.sugar,
         free_sulfur_dioxide = free.sulfur.dioxide,
         total_sulfur_dioxide = total.sulfur.dioxide
         )

```

```{r, type_cast, include=F}
# Identify column data types
df.numeric = c("fixed_acidity","volatile_acidity", "citric_acid", "residual_sugar", "chlorides", "density", "pH", "sulphates", "alcohol", "quality")
df.int = c("free_sulfur_dioxide", "total_sulfur_dioxide")
df.factor = c("color")

df[df.numeric] <- lapply(df[df.numeric], as.numeric)
df[df.int] <- lapply(df[df.int], as.integer)
df[df.factor] <- lapply(df[df.factor], as.factor)

rm(df.numeric, df.int, df.factor)

# relevel color base as white (red wines are generally more premium)

df$color <- df$color %>% relevel(ref = "White")

str(df)

```

# Analysis

Free sulfur dioxide and total sulfur dioxide are highly correlated so only one of the two variables was used in the final model


```{r, data_explorer, include=F}
# Data Explorer Generation
# DataExplorer::create_report(df)

# report_config <- configure_report(
#   add_introduce = TRUE,
#   add_plot_intro = TRUE,
#   # add_plot_str = TRUE,
#   add_plot_missing = TRUE,
#   add_plot_histogram = TRUE,
#   add_plot_density = FALSE,
#   add_plot_qq = TRUE,
#   add_plot_bar = TRUE,
#   add_plot_correlation = TRUE,
#   # add_plot_prcomp = TRUE,
#   add_plot_boxplot = TRUE,
#   add_plot_scatterplot = TRUE,
#   introduce_args = list(),
#   plot_intro_args = list(),
#   plot_str_args = list(type = "diagonal", fontSize = 35, width = 1000, margin =
#     list(left = 350, right = 250)),
#   plot_missing_args = list(),
#   plot_histogram_args = list(),
#   plot_density_args = list(),
#   plot_qq_args = list(sampled_rows = 1000L),
#   plot_bar_args = list(),
#   plot_correlation_args = list(cor_args = list(use = "pairwise.complete.obs")),
#   plot_prcomp_args = list(),
#   plot_boxplot_args = list(),
#   plot_scatterplot_args = list(sampled_rows = 1000L),
#   global_ggtheme = quote(theme_gray()),
#   global_theme_config = list()
# )
# 
# create_report(
#   df,
#   output_dir = "output/",
#   y = "quality",
#   report_title = "Wine Summary",
#   config = report_config
# )

```

```{r, exploratory_plots, echo=F}
# Exploratory Data Analysis Plots
plot_intro(df)
plot_bar(df)
plot_histogram(df)
plot_correlation(df, type = "c")
```

From this we notice that free and total sulfur dioxide are highly correlated. Thus only one of the two was used in the analysis.

```{r, data_summary, include = F}
data.summary(df)
```

```{r, outlier_plots}
# Investigate unusual columns
plot(df$quality, df$density)
plot(df$quality, df$residual_sugar)

```

```{r, outlier_removal, include=F}
# Remove outliers from residual sugar and density

df_outlier <- which(df$residual_sugar > 60) 

df_outlier %>% 
  union(which(df$density > 1.03)) -> df_outlier

df = df[-df_outlier,]

```

## Final Explanatory Model
```{r, training_split, include=F}
set.seed(3)
trainIndex = sample(1:nrow(df), size = round(0.6*nrow(df)), replace=FALSE)
df.train <- df[trainIndex, ]
df.valid <- df[-trainIndex, ]
rm(trainIndex)
```

```{r, model, include=F}
# Linear model
lm(sqrt(quality) ~
  volatile_acidity +
  free_sulfur_dioxide +
  alcohol +
  color,
  data = df.train) -> df.reg

summary(df.reg)
```

The variables used in the final model are:
- Volatile aciditity
- Free sulfur dioxide
- Alcohol
- Color

```{r, rmse, include=F}
# Calculate predicted values for validation set and transform
df.valid$quality_pred <- predict(df.reg, newdata=df.valid)
df.valid <- df.valid %>% 
  mutate(quality_pred_adj = I(quality_pred^2))

# Compare RMSE calculation to caret package
rmse <- caret::RMSE(df.valid$quality_pred_adj, df.valid$quality)
```

The model has an overall RMSE of `r round(rmse, digits=2)`

### Model Assumptions

**Mean of Error Term**

```{r, include = F}
mean(df.reg$residuals)
```

The mean of the probability distribution of the error is $\approx 0$, Therefore this assumption is passed.

**Variance of Error Term**

```{r, echo = FALSE}
plot(df.reg$fitted.values, df.reg$residuals, 
     ylab = "Residuals", 
     xlab = "Fitted Values", 
     main = "Residuals vs. Fitted Values")
abline(0,0, col = "red")
```

The variance of the probability distribution of the error looks [insert], so this assumptions is passed.

**Normal Distribution of Error Term**

```{r, echo = FALSE}
qqnorm(df.reg$residuals)
qqline(df.reg$residuals, col = "red")
```

The QQ Plot deviation in the lower left and upper right corners indicates long tails on both the lower and upper ends of the wine quality.

Between this plot and the above residual plot, we can assume that the error is normally distributed.

**Independent Observations**

Additionally, we can assume that each of these observations are independent of each other as each one represents a separate bottle of wine.

### Predictive Power

Since there are only 4 observations with a quality of 9, and no observations with a quality of 10, high predicted qualities should be approached with caution.


# Conclusion
